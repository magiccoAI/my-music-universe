import React, { useRef, useState, useEffect, useContext } from 'react';
import { Canvas, useFrame, useThree } from '@react-three/fiber';
import { OrbitControls, Plane, Html, useTexture } from '@react-three/drei';
import Stars from './components/StarsOnly';
import CloudSprite from './components/CloudSprite'; // Import the new CloudSprite component
import UniverseNavigation from './components/UniverseNavigation';
import * as THREE from 'three';
import { UniverseContext } from './UniverseContext';

const Cover = ({ data, position, rotation, scale, onPointerOver, onPointerOut, onClick }) => {
  const meshRef = useRef();
  const texture = useTexture(`/covers/${data.cover.split('/').pop()}`);
  const [hovered, setHovered] = useState(false);
  const { gl, camera } = useThree();

  useFrame(({ clock }) => {
    if (meshRef.current) {
      // Subtle floating animation
      meshRef.current.position.y = position[1] + Math.sin(clock.getElapsedTime() * 0.5 + data.id) * 0.1; // Adjusted for subtle float
      meshRef.current.lookAt(camera.position);
    }
  });

  useEffect(() => {
    if (hovered) {
      gl.domElement.style.cursor = 'pointer';
    } else {
      gl.domElement.style.cursor = 'auto';
    }
  }, [hovered, gl]);

  return (
    <Plane
      args={[1, 1]}
      ref={meshRef}
      position={position}
      rotation={rotation}
      scale={scale}
      onPointerOver={(event) => {
        event.stopPropagation();
        setHovered(true);
        onPointerOver(data, position);
      }}
      onPointerOut={() => {
        setHovered(false);
        onPointerOut();
      }}
      onClick={(event) => {
        event.stopPropagation();
        onClick(data);
      }}
      onPointerMove={(event) => {
        if (hovered) {
          onPointerOver(data, position);
        }
      }}
    >
      <meshBasicMaterial attach="material" map={texture} transparent />
    </Plane>
  );
};

const MusicUniverse = () => {
  const [musicData, setMusicData] = useState([]);
  const [selectedMusic, setSelectedMusic] = useState(null);
  const [hoveredMusic, setHoveredMusic] = useState(null);
  const [currentTheme, setCurrentTheme] = useState('night'); // Default theme
  const { isConnectionsPageActive } = useContext(UniverseContext);

  const themes = {
    day: "bg-gradient-to-b from-blue-900 via-blue-600 to-blue-300", // 白天：飞机上看到的深蓝到浅蓝渐变
    // 替换您当前的傍晚渐变代码
    evening: "evening-symmetric", // 傍晚：日落海面多色渐变
    night: "bg-gradient-to-br from-indigo-900 via-purple-900 to-blue-800", // 夜晚：银河星系的深色弥散渐变
  };

  useEffect(() => {
    fetch('/data/data.json')
      .then((res) => res.json())
      .then((data) => {
        const processedData = data.map((item, index) => {
          const randomOffsetX = (Math.random() - 0.5) * 25; // Larger spread
          const randomOffsetY = (Math.random() - 0.5) * 25;
          const randomOffsetZ = (Math.random() - 0.5) * 25;
          const rotationX = (Math.random() - 0.5) * Math.PI * 0.4; // Max 72 degrees
          const rotationY = (Math.random() - 0.5) * Math.PI * 0.4;
          const rotationZ = (Math.random() - 0.5) * Math.PI * 0.4;
          const scale = 0.8 + (Math.random() * 0.4); // 0.8 to 1.2

          return {
            ...item,
            position: [randomOffsetX, randomOffsetY, randomOffsetZ],
            rotation: [rotationX, rotationY, rotationZ],
            scale: scale,
          };
        });
        setMusicData(processedData);
      })
      .catch((error) => console.error('Error loading music data:', error));
  }, []);

  const handleCoverClick = (data) => {
    setSelectedMusic(data);
  };

  const handleCoverHover = (data, albumPosition) => {
    setHoveredMusic({ data, position: albumPosition });
  };

  const handleCoverOut = () => {
    setHoveredMusic(null);
  };

  const InfoCard = ({ music, position }) => {
    if (!music) return null;
    const cardPosition = music.position ? [music.position[0] + 0.7, music.position[1] + 0.7, music.position[2] + 0.1] : [0, 0, 0];

    return (
      <Html position={cardPosition} transform>
        <div className="bg-white p-4 rounded-lg shadow-lg max-w-xs text-gray-800 text-sm">
          <h3 className="font-bold text-md mb-1">{music.title}</h3>
          <p><strong>音乐:</strong> {music.music}</p>
          <p><strong>艺术家:</strong> {music.artist}</p>
          <p><strong>专辑:</strong> {music.album}</p>
          <p><strong>日期:</strong> {music.date}</p>
          {music.note && <p><strong>备注:</strong> {music.note}</p>}
          {music.url && (
            <a href={music.url} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline mt-2 block">
              查看原文
            </a>
          )}
        </div>
      </Html>
    );
  };

  const CameraSetup = () => {
    const { camera } = useThree();
    const cameraRef = useRef(camera);

    useEffect(() => {
      camera.position.set(0, 0, 10);
      camera.lookAt(0, 0, 0);
      cameraRef.current = camera;
    }, [camera]);

    useFrame(() => {
      // This will make sure the cameraRef is always up-to-date
      cameraRef.current = camera;
    });

    return null;
  };

  const KeyboardControls = () => {
    const { camera } = useThree();
    const speed = 0.5; // Adjust camera movement speed

    useEffect(() => {
      const handleKeyDown = (event) => {
        switch (event.key) {
          case 'ArrowLeft':
            camera.position.x -= speed;
            break;
          case 'ArrowRight':
            camera.position.x += speed;
            break;
          case 'ArrowUp':
            camera.position.z -= speed;
            break;
          case 'ArrowDown':
            camera.position.z += speed;
            break;
          default:
            break;
        }
      };

      window.addEventListener('keydown', handleKeyDown);
      return () => {
        window.removeEventListener('keydown', handleKeyDown);
      };
    }, [camera, speed]);

    return null;
  };

  return (
    <div className={`w-screen h-screen ${themes[currentTheme]}`}>
      <UniverseNavigation />
      <Canvas style={{ width: '100%', height: '100%' }} camera={{ fov: 75, near: 0.1, far: 1000 }} className={isConnectionsPageActive ? 'filter blur-lg scale-90 transition-all duration-500' : 'transition-all duration-500'}>
        <CameraSetup />
        <KeyboardControls />
        <ambientLight intensity={0.5} />
        <pointLight position={[10, 10, 10]} />
        {currentTheme === 'night' && <Stars />}
        {currentTheme === 'day' && (
          <>
            {/* Replace existing cloud divs with CloudSprite components */}
            <CloudSprite position={[-5, 2, -10]} scale={[5, 3, 1]} speed={0.01} textureName="cloud1" />
            <CloudSprite position={[0, -1, -15]} scale={[7, 4, 1]} speed={0.008} textureName="cloud2" />
            <CloudSprite position={[5, 3, -20]} scale={[6, 3.5, 1]} speed={0.005} textureName="cloud3" />
            <CloudSprite position={[-8, 0, -12]} scale={[4, 2.5, 1]} speed={0.012} textureName="cloud1" />
            <CloudSprite position={[2, 4, -18]} scale={[5.5, 3, 1]} speed={0.007} textureName="cloud2" />
            <CloudSprite position={[-3, -3, -22]} scale={[6.5, 4, 1]} speed={0.009} textureName="cloud3" />
          </>
        )}

        {/* <OrbitControls /> */}

        {musicData.map((data) => (
          <Cover
            key={data.id}
            data={data}
            position={data.position}
            rotation={data.rotation}
            scale={data.scale}
            onPointerOver={handleCoverHover}
            onPointerOut={handleCoverOut}
            onClick={handleCoverClick}
          />
        ))}
        {hoveredMusic && <InfoCard music={hoveredMusic.data} position={hoveredMusic.position} />}
        {/* {selectedMusic && <InfoCard music={selectedMusic} />} */}
      </Canvas>
      <div className="absolute bottom-4 right-4 z-10 flex space-x-2">
        <button
          className={`px-4 py-2 rounded-full text-white font-bold ${currentTheme === 'day' ? 'bg-blue-500' : 'bg-gray-700 hover:bg-blue-500'}`}
          onClick={() => setCurrentTheme('day')}
        >
          白天
        </button>
        <button
          className={`px-4 py-2 rounded-full text-white font-bold ${currentTheme === 'evening' ? 'bg-orange-500' : 'bg-gray-700 hover:bg-orange-500'}`}
          onClick={() => setCurrentTheme('evening')}
        >
          傍晚
        </button>
        <button
          className={`px-4 py-2 rounded-full text-white font-bold ${currentTheme === 'night' ? 'bg-purple-500' : 'bg-gray-700 hover:bg-purple-500'}`}
          onClick={() => setCurrentTheme('night')}
        >
          夜晚
        </button>
      </div>
    </div>
  );
};

export default MusicUniverse;