import React, { useEffect, useState } from 'react';

import { OrbitControls } from '@react-three/drei';
import { Link, useLocation } from 'react-router-dom';
import WordCloudDisplay from '../components/WordCloudDisplay';
import TimelineJourney from '../components/TimelineView';
//import MusicMoodMap from '../components/MusicMoodMap';
import SpecialCollection from '../components/SpecialCollection';
import MouseParticleEffect from '../components/MouseParticleEffect';

import './ArchivePage.css';

const ArchivePage = () => {
  const [musicData, setMusicData] = useState([]);
  const [aggregatedData, setAggregatedData] = useState({ artist_counts: {}, style_counts: {} });
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [activeGalaxy, setActiveGalaxy] = useState('artist');
  const [hoveredSection, setHoveredSection] = useState(null);
  const location = useLocation();

  useEffect(() => {
    const fetchData = async () => {
      try {
        const [musicResponse, aggregatedResponse] = await Promise.all([
          fetch('/data/data.json'),
          fetch('/data/aggregated_data.json')
        ]);

        if (!musicResponse.ok || !aggregatedResponse.ok) {
          throw new Error(`数据加载失败: ${musicResponse.status} ${aggregatedResponse.status}`);
        }

        const [musicJson, aggregatedJson] = await Promise.all([
          musicResponse.json(),
          aggregatedResponse.json()
        ]);

        setMusicData(musicJson);

        // 合并标签
        const mergedStyle = { ...aggregatedJson.style_counts };
        if (mergedStyle['graphic background music']) {
          mergedStyle['motion'] = (mergedStyle['motion'] || 0) + mergedStyle['graphic background music'];
          delete mergedStyle['graphic background music'];
        }
        aggregatedJson.style_counts = mergedStyle;
        setAggregatedData(aggregatedJson);

      } catch (err) {
        console.error("Failed to fetch data:", err);
        setError(err.message);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, []);

  // 鼠标悬置处理函数
  const handleSectionHover = (section) => {
    setHoveredSection(section);
  };

  const handleSectionLeave = () => {
    setHoveredSection(null);
  };

  const handleArtistClick = (artistName) => {
    console.log(`Artist clicked: ${artistName}`);
    // 可以添加跳转到艺术家详情页或筛选功能
  };

  const handleStyleClick = (styleName) => {
    console.log(`Music style clicked: ${styleName}`);
    // 可以添加跳转到风格详情页或筛选功能
  };

  // 统计卡片数据
  const statsData = [
    { icon: '👂', number: '402', label: '共402首音乐收藏', color: '#ff6b6b' },
    { icon: '🌈', number: '28', label: '涵盖28种音乐风格', color: '#4ecdc4' },
    { icon: '🌟', number: '356', label: '与356位艺术家相遇', color: '#45b7d1' },
    { icon: '📅', number: '438', label: '跨越438天的音乐旅程', color: '#96ceb4' }
  ];

  if (loading) {
    return (
      <div className="loading-container">
        <div className="loading-spinner"></div>
        <div className="loading-text">时光机启动中...</div>
        <div className="loading-subtext">正在加载您的音乐记忆</div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="error-container">
        <div className="error-icon">🎵</div>
        <div className="error-text">音乐数据加载失败</div>
        <div className="error-details">{error}</div>
        <button className="retry-btn" onClick={() => window.location.reload()}>
          重新加载
        </button>
      </div>
    );
  }

  return (
    <div className="archive-page">
      <MouseParticleEffect />

      
      {/* 背景星空效果 */}
      <div className="stars-background"></div>
      <div className="gradient-overlay"></div>
      
      {/* 导航栏 */}
      <nav className="main-nav">
        <div className="nav-content">
          <Link 
            to="/" 
            className={`nav-link ${location.pathname === '/' ? 'active' : ''}`}
          >
            <span className="nav-icon">🏠</span>
            首页
          </Link>
          <Link 
            to="/music-universe" 
            className={`nav-link ${location.pathname === '/music-universe' ? 'active' : ''}`}
          >
            <span className="nav-icon">🌌</span>
            音乐封面宇宙
          </Link>
          <Link 
            to="/archive" 
            className={`nav-link ${location.pathname === '/archive' ? 'active' : ''}`}
          >
            <span className="nav-icon">🎵</span>
            我的音乐时光机
          </Link>
        </div>
      </nav>

      {/* 英雄区域 */}
      <section className="hero-section">
        <div className="hero-content">
          <div className="hero-titles">
            <h1 className="hero-title">
              <span className="title-accent">2022-2023</span>
              <span className="title-main">音乐时光机</span>
              <span className="title-sub">· 轨迹 ·</span>
            </h1>
            <h2 className="hero-subtitle">
              个人公众号：「D小调片段记录」的音乐分享歌单
            </h2>
          </div>
          
          <div className="stats-grid">
            {statsData.map((stat, index) => (
              <div 
                key={index}
                className="stat-card"
                onMouseEnter={() => handleSectionHover(`stat-${index}`)}
                onMouseLeave={handleSectionLeave}
                data-hovered={hoveredSection === `stat-${index}`}
              >
                <div 
                  className="stat-icon"
                  style={{ '--icon-color': stat.color }}
                >
                  {stat.icon}
                </div>
                <div className="stat-number">{stat.number}</div>
                <div className="stat-label">{stat.label}</div>
                <div className="stat-glow" style={{ '--glow-color': stat.color }}></div>
              </div>
            ))}
          </div>
        </div>
        
        {/* 滚动指示器 */}
        <div className="scroll-indicator">
          <div className="scroll-arrow"></div>
          <span>探索更多</span>
        </div>
      </section>

      {/* 音乐时光轴 */}
      <section 
        className="section-container timeline-section"
        onMouseEnter={() => handleSectionHover('timeline')}
        onMouseLeave={handleSectionLeave}
        data-hovered={hoveredSection === 'timeline'}
      >
        <div className="section-header">
          <div className="section-icon">⏳</div>
          <h2 className="section-title">听歌时光轴</h2>
          <p className="section-subtitle">回顾音乐旅程中的重要时刻</p>
        </div>
        <div className="timeline-container">
          <TimelineJourney />
        </div>
        <div className="section-glow"></div>
      </section>

      {/* 音乐词云星系 */}
      <section 
        className="section-container galaxy-section"
        onMouseEnter={() => handleSectionHover('galaxy')}
        onMouseLeave={handleSectionLeave}
        data-hovered={hoveredSection === 'galaxy'}
      >
        <div className="section-header">
          <div className="section-icon">🌠</div>
          <h2 className="section-title">音乐词云星系</h2>
          <p className="section-subtitle">点击探索你的音乐宇宙</p>
        </div>
        
        <div className="galaxy-controls">
          <button
            className={`galaxy-btn ${activeGalaxy === 'artist' ? 'active' : ''}`}
            onClick={() => setActiveGalaxy('artist')}
            onMouseEnter={(e) => e.currentTarget.classList.add('hover')}
            onMouseLeave={(e) => e.currentTarget.classList.remove('hover')}
          >
            <span className="btn-icon">🎤</span>
            <span className="btn-text">艺术家星系</span>
            <span className="btn-glow"></span>
          </button>
          <button
            className={`galaxy-btn ${activeGalaxy === 'style' ? 'active' : ''}`}
            onClick={() => setActiveGalaxy('style')}
            onMouseEnter={(e) => e.currentTarget.classList.add('hover')}
            onMouseLeave={(e) => e.currentTarget.classList.remove('hover')}
          >
            <span className="btn-icon">🎼</span>
            <span className="btn-text">风格星系</span>
            <span className="btn-glow"></span>
          </button>
        </div>

        <div className="wordcloud-container">
          {activeGalaxy === 'artist' && (
            <WordCloudDisplay 
              data={aggregatedData.artist_counts} 
              type="artist"
              maxWords={50}
              onWordClick={handleArtistClick}
            />
          )}
          {activeGalaxy === 'style' && (
            <WordCloudDisplay 
              data={aggregatedData.style_counts} 
              type="style"
              maxWords={50}
              onWordClick={handleStyleClick}
            />
          )}
        </div>
        <div className="section-glow"></div>
      </section>

      {/* 特别收藏 */}
      <section 
        className="section-container special-section"
        onMouseEnter={() => handleSectionHover('special')}
        onMouseLeave={handleSectionLeave}
        data-hovered={hoveredSection === 'special'}
      >
        <div className="section-header">
          <div className="section-icon">💫</div>
          <h2 className="section-title">特别收藏</h2>
          <p className="section-subtitle">那些触动心灵的珍贵旋律</p>
        </div>
        <div className="special-collection-container">
          <SpecialCollection musicData={musicData} />
        </div>
        <div className="section-glow"></div>
      </section>

      {/* 页脚 */}
      <footer className="page-footer">
        <div className="footer-content">
          <p className="footer-text">
            <span className="footer-icon">🎵</span>
            音乐让时光有了温度
            <span className="footer-icon">🎵</span>
          </p>
          <div className="footer-decoration">✦ ✦ ✦</div>
          <div className="footer-subtext">感谢每一段旋律的陪伴</div>
        </div>
      </footer>
    </div>
  );
};

export default ArchivePage;